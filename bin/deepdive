#!/usr/bin/python3
import logging

from dict_tools.data import NamespaceDict
from funtoo.merge.tree import GitTree
from subpop.hub import Hub

hub = Hub()

import dyne.org.funtoo.metatools.merge as merge


async def insert_kit(ctx):
	ctx, items_to_insert = await merge.kit.get_deepdive_kit_items(ctx)
	if not len(items_to_insert):
		logging.warning(f"No items to insert for {ctx.kit.name}")
		return
	result = hub.DEEPDIVE.insert_many(items_to_insert)
	print(f"kit {ctx.kit.name} - inserted {len(result.inserted_ids)} items.")
	if len(items_to_insert) != len(result.inserted_ids):
		raise KeyError("Number of inserted items does not match!")


if __name__ == "__main__":

	hub.set_model("org.funtoo.metatools/merge", release="1.4-release")
	# force init
	getattr(merge, "foundations", None)
	hub.GIT_CLASS = GitTree
	hub.FIXUP_REPO = GitTree(
		"kit-fixups",
		hub.MERGE_CONFIG.branch("kit-fixups"),
		url=hub.MERGE_CONFIG.kit_fixups,
		root=hub.MERGE_CONFIG.source_trees + "/kit-fixups",
	)
	hub.META_REPO = meta_repo = GitTree(
		"meta-repo",
		branch=hub.RELEASE,
		url=hub.MERGE_CONFIG.meta_repo,
		root=hub.MERGE_CONFIG.dest_trees + "/meta-repo",
		origin_check=False,
		pull=False,
	)

	hub.META_REPO.initialize()
	hub.FIXUP_REPO.initialize()
	hub.KIT_GROUPS = list(merge.foundations.kit_groups())
	pipeline_keys, pipeline_groups = merge.sources.get_kits_in_correct_processing_order()

	hub.DEEPDIVE.delete_many({})
	for source in pipeline_keys:
		kit_dict_list = pipeline_groups[source]
		for kit_dict in kit_dict_list:
			ctx = NamespaceDict({"kit": NamespaceDict(kit_dict)})
			hub.LOOP.run_until_complete(insert_kit(ctx))
